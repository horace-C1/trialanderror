<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocol Tracker PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 1rem; padding-bottom: 80px; }
    input, textarea, select, button { width: 100%; margin: 5px 0; padding: 8px; font-size: 1rem; }
    h2 { margin-top: 1rem; }
    .task { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    .subtask { margin-left: 15px; }
    .completed { color: gray; text-decoration: line-through; }
    .overdue { color: red; }

    /* Bottom navigation */
    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #ccc;
      padding: 10px 0;
      z-index: 999;
    }
    #bottom-nav button {
      font-size: 24px;
      border: none;
      background: none;
      flex: 1;
      text-align: center;
      cursor: pointer;
    }
    #bottom-nav button.active {
      background-color: #0d6efd;
      color: white;
      border-radius: 6px;
    }
    .page { display: none; }
  </style>
</head>
<body>

<h1>ğŸ“Š Protocol Tracker1106</h1>

<!-- Pages -->
<div id="dashboardPage" class="page"></div>
<div id="createPage" class="page"></div>
<div id="tasksPage" class="page"></div>
<div id="dailyPage" class="page"></div>
<div id="projectsPage" class="page"></div>

<!-- Bottom Navigation -->
<div id="bottom-nav">
  <button id="nav-dashboard" onclick="navigate('dashboard')">ğŸ </button>
  <button id="nav-create" onclick="navigate('create')">â•</button>
  <button id="nav-tasks" onclick="navigate('tasks')">ğŸ“‹</button>
  <button id="nav-daily" onclick="navigate('daily')">ğŸ“…</button>
  <button id="nav-projects" onclick="navigate('projects')">ğŸ“‚</button>
</div>

<script>

  // ================= Force new SW =================
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
      reg.update(); // check for new SW
      reg.onupdatefound = () => {
        const newWorker = reg.installing;
        newWorker.onstatechange = () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // New update available
            newWorker.postMessage({ type: 'SKIP_WAITING' });
            window.location.reload(); // reload to apply changes
          }
        };
      };
    });
  }

  // ================= Dexie DB Setup =================
  const db = new Dexie("protocolTrackerDB");
  db.version(1).stores({
    tasks: "++id, project, task, description, status, created_at"
  });

  const pages = {
    dashboard: document.getElementById("dashboardPage"),
    create: document.getElementById("createPage"),
    tasks: document.getElementById("tasksPage"),
    daily: document.getElementById("dailyPage"),
    projects: document.getElementById("projectsPage")
  };

  // ================= Navigation =================
  function navigate(page) {
    // hide all pages
    Object.values(pages).forEach(p => p.style.display = 'none');
    // show selected page
    pages[page].style.display = 'block';
    // highlight active button
    document.querySelectorAll('#bottom-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById("nav-" + page).classList.add('active');
    // render page content
    renderPage(page);
  }

  // ================= Helper: Extract subtasks =================
  function extractSubtasks(description) {
    const pattern = /(\d{4}):\s*(.+)/g;
    let match, subtasks = [];
    while ((match = pattern.exec(description)) !== null) {
      let code = match[1];
      let text = match[2];
      subtasks.push({date_code: code, title: text, status: "Not Started"});
    }
    return subtasks;
  }

  // ================= Pages =================
  async function renderPage(page) {
    if (page === "dashboard") {
      const dash = pages.dashboard;
      dash.innerHTML = "<h2>ğŸ“Š Dashboard</h2>";
      const tasks = await db.tasks.toArray();
      const totalProjects = new Set(tasks.map(t => t.project)).size;
      const totalTasks = tasks.length;
      let todayNum = parseInt(new Date().toISOString().slice(5,7)+new Date().toISOString().slice(8,10));
      let overdue = 0, today = 0;
      tasks.forEach(t => {
        t.subtasks?.forEach(s => {
          let num = parseInt(s.date_code);
          if(s.status !== "Completed") {
            if(num < todayNum) overdue++;
            else if(num === todayNum) today++;
          }
        });
      });
      dash.innerHTML += `<p>ğŸ§ª Total Projects: ${totalProjects}</p>`;
      dash.innerHTML += `<p>ğŸ“‚ Total Tasks: ${totalTasks}</p>`;
      dash.innerHTML += `<p>âš ï¸ Overdue Subtasks: ${overdue}</p>`;
      dash.innerHTML += `<p>ğŸ“… Today's Subtasks: ${today}</p>`;
    }

    if(page === "create") {
      const create = pages.create;
      create.innerHTML = `<h2>â• Create Task</h2>
      <input id="projInput" placeholder="Project Name">
      <input id="taskInput" placeholder="Task Name">
      <textarea id="descInput" placeholder="Task Description (use 0101: Subtask format)"></textarea>
      <select id="statusInput">
        <option>Not Started</option>
        <option>In Progress</option>
        <option>Completed</option>
      </select>
      <button id="saveBtn">Save Task</button>
      <p id="msg"></p>`;
      document.getElementById("saveBtn").onclick = async () => {
        const project = document.getElementById("projInput").value.trim();
        const task = document.getElementById("taskInput").value.trim();
        const description = document.getElementById("descInput").value.trim();
        const status = document.getElementById("statusInput").value;
        if(!project || !task) { document.getElementById("msg").innerText="Fill project & task!"; return; }
        const subtasks = extractSubtasks(description);
        await db.tasks.add({ project, task, description, status, subtasks, created_at: new Date().toISOString() });
        document.getElementById("msg").innerText = "âœ… Task Saved!";
        document.getElementById("projInput").value="";
        document.getElementById("taskInput").value="";
        document.getElementById("descInput").value="";
      };
    }

    if(page === "tasks") {
      const tasksDiv = pages.tasks;
      tasksDiv.innerHTML = "<h2>ğŸ“‹ Current Tasks</h2>";
      const tasks = await db.tasks.reverse().toArray();
      tasksDiv.innerHTML += tasks.map((t, idx) => {
        let subHTML = t.subtasks?.map((s, si) => `<div class="subtask ${s.status==='Completed'?'completed':''}">${s.date_code}: ${s.title} [${s.status}] <button onclick="completeSub(${t.id},${si})">âœ…</button></div>`).join('') || '';
        return `<div class="task"><h3>${t.task} (${t.project})</h3>
                <p>Status: ${t.status}</p>
                <p>${t.description}</p>
                ${subHTML}
                <button onclick="deleteTask(${t.id})">ğŸ—‘ï¸ Delete Task</button></div>`;
      }).join('');
    }

    if(page === "daily") {
      const dailyDiv = pages.daily;
      dailyDiv.innerHTML="<h2>ğŸ“… Daily Tasks</h2>";
      const tasks = await db.tasks.toArray();
      const todayNum = parseInt(new Date().toISOString().slice(5,7)+new Date().toISOString().slice(8,10));
      tasks.forEach(t => {
        t.subtasks?.forEach((s, si) => {
          const subNum = parseInt(s.date_code);
          if(subNum<=todayNum && s.status!=="Completed") {
            dailyDiv.innerHTML += `<p>${t.task} - ${s.title} <button onclick="completeSub(${t.id},${si})">âœ… Complete</button></p>`;
          }
        });
      });
    }

    if(page==="projects") {
      const projDiv = pages.projects;
      projDiv.innerHTML="<h2>ğŸ“‚ Project Overview</h2>";
      const tasks = await db.tasks.toArray();
      const projects = {};
      tasks.forEach(t => { projects[t.project] = projects[t.project]||[]; projects[t.project].push(t); });
      for(const [proj, tlist] of Object.entries(projects)) {
        projDiv.innerHTML += `<h3>${proj}</h3>`;
        tlist.forEach(t => {
          let subHTML = t.subtasks?.map(s=>`<p class="${s.status==='Completed'?'completed':''}">${s.date_code}: ${s.title} [${s.status}]</p>`).join('')||'_No subtasks_';
          projDiv.innerHTML += `<div class="task"><strong>${t.task}</strong>${subHTML}</div>`;
        });
      }
    }
  }

  // ================= CRUD functions =================
  window.deleteTask = async (id) => { await db.tasks.delete(id); renderPage(currentPage); };
  window.completeSub = async (taskId, subIdx) => {
    const task = await db.tasks.get(taskId);
    task.subtasks[subIdx].status = "Completed";
    await db.tasks.put(task);
    renderPage(currentPage);
  };

  // ================= Service Worker =================
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

  // ================= Initial Render =================
  let currentPage = "dashboard";
  navigate(currentPage);
</script>
</body>
</html>



