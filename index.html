<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocol Tracker PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 1rem; }
    input, textarea, select, button { width: 100%; margin: 5px 0; padding: 8px; font-size: 1rem; }
    h2 { margin-top: 1rem; }
    .task { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    .subtask { margin-left: 15px; }
    .completed { color: gray; text-decoration: line-through; }
    .overdue { color: red; }
  </style>
</head>
<body>

<h1>ğŸ“Š Protocol Tracker PWA</h1>

<!-- Navigation -->
<select id="pageSelect">
  <option value="dashboard">Dashboard</option>
  <option value="create">â• Create Task</option>
  <option value="tasks">ğŸ“‹ Current Tasks</option>
  <option value="daily">ğŸ“… Daily Tasks</option>
  <option value="projects">ğŸ“‚ Project Overview</option>
</select>

<hr>

<!-- Pages -->
<div id="dashboardPage" class="page"></div>
<div id="createPage" class="page" style="display:none;"></div>
<div id="tasksPage" class="page" style="display:none;"></div>
<div id="dailyPage" class="page" style="display:none;"></div>
<div id="projectsPage" class="page" style="display:none;"></div>

<script>
  // ================= Dexie DB Setup =================
  const db = new Dexie("protocolTrackerDB");
  db.version(1).stores({
    tasks: "++id, project, task, description, status, created_at"
  });

  // ================= Navigation =================
  const pageSelect = document.getElementById("pageSelect");
  const pages = {
    dashboard: document.getElementById("dashboardPage"),
    create: document.getElementById("createPage"),
    tasks: document.getElementById("tasksPage"),
    daily: document.getElementById("dailyPage"),
    projects: document.getElementById("projectsPage")
  };

  pageSelect.addEventListener("change", () => {
    for (let key in pages) pages[key].style.display = "none";
    pages[pageSelect.value].style.display = "block";
    renderPage(pageSelect.value);
  });

  // ================= Helper: Extract subtasks =================
  function extractSubtasks(description) {
    const pattern = /(\d{4}):\s*(.+)/g;
    let match, subtasks = [];
    while ((match = pattern.exec(description)) !== null) {
      let code = match[1];
      let text = match[2];
      subtasks.push({date_code: code, title: text, status: "Not Started"});
    }
    return subtasks;
  }

  // ================= Pages =================
  async function renderPage(page) {
    if (page === "dashboard") {
      const dash = pages.dashboard;
      dash.innerHTML = "<h2>ğŸ“Š Dashboard</h2>";
      const tasks = await db.tasks.toArray();
      const totalProjects = new Set(tasks.map(t => t.project)).size;
      const totalTasks = tasks.length;

      let todayNum = parseInt(new Date().toISOString().slice(5,7)+new Date().toISOString().slice(8,10));
      let overdue = 0, today = 0;
      tasks.forEach(t => {
        t.subtasks?.forEach(s => {
          let num = parseInt(s.date_code);
          if(s.status !== "Completed") {
            if(num < todayNum) overdue++;
            else if(num === todayNum) today++;
          }
        });
      });

      dash.innerHTML += `<p>ğŸ§ª Total Projects: ${totalProjects}</p>`;
      dash.innerHTML += `<p>ğŸ“‚ Total Tasks: ${totalTasks}</p>`;
      dash.innerHTML += `<p>âš ï¸ Overdue Subtasks: ${overdue}</p>`;
      dash.innerHTML += `<p>ğŸ“… Today's Subtasks: ${today}</p>`;
    }

    if(page === "create") {
      const create = pages.create;
      create.innerHTML = `<h2>â• Create Task</h2>
      <input id="projInput" placeholder="Project Name">
      <input id="taskInput" placeholder="Task Name">
      <textarea id="descInput" placeholder="Task Description (use 0101: Subtask format)"></textarea>
      <select id="statusInput">
        <option>Not Started</option>
        <option>In Progress</option>
        <option>Completed</option>
      </select>
      <button id="saveBtn">Save Task</button>
      <p id="msg"></p>`;

      document.getElementById("saveBtn").onclick = async () => {
        const project = document.getElementById("projInput").value.trim();
        const task = document.getElementById("taskInput").value.trim();
        const description = document.getElementById("descInput").value.trim();
        const status = document.getElementById("statusInput").value;
        if(!project || !task) { document.getElementById("msg").innerText="Fill project & task!"; return; }

        const subtasks = extractSubtasks(description);
        await db.tasks.add({
          project, task, description, status, subtasks, created_at: new Date().toISOString()
        });
        document.getElementById("msg").innerText = "âœ… Task Saved!";
        document.getElementById("projInput").value="";
        document.getElementById("taskInput").value="";
        document.getElementById("descInput").value="";
      };
    }

    if(page === "tasks") {
      const tasksDiv = pages.tasks;
      tasksDiv.innerHTML = "<h2>ğŸ“‹ Current Tasks</h2>";
      const tasks = await db.tasks.reverse().toArray();
      tasksDiv.innerHTML += tasks.map((t, idx) => {
        let subHTML = t.subtasks?.map((s, si) => `<div class="subtask ${s.status==='Completed'?'completed':''}">${s.date_code}: ${s.title} [${s.status}] <button onclick="completeSub(${t.id},${si})">âœ…</button></div>`).join('') || '';
        return `<div class="task"><h3>${t.task} (${t.project})</h3>
                <p>Status: ${t.status}</p>
                <p>${t.description}</p>
                ${subHTML}
                <button onclick="deleteTask(${t.id})">ğŸ—‘ï¸ Delete Task</button></div>`;
      }).join('');
    }

    if(page === "daily") {
      const dailyDiv = pages.daily;
      dailyDiv.innerHTML="<h2>ğŸ“… Daily Tasks</h2>";
      const tasks = await db.tasks.toArray();
      const todayNum = parseInt(new Date().toISOString().slice(5,7)+new Date().toISOString().slice(8,10));
      tasks.forEach(t => {
        t.subtasks?.forEach((s, si) => {
          const subNum = parseInt(s.date_code);
          if(subNum<=todayNum && s.status!=="Completed") {
            dailyDiv.innerHTML += `<p>${t.task} - ${s.title} <button onclick="completeSub(${t.id},${si})">âœ… Complete</button></p>`;
          }
        });
      });
    }

    if(page==="projects") {
      const projDiv = pages.projects;
      projDiv.innerHTML="<h2>ğŸ“‚ Project Overview</h2>";
      const tasks = await db.tasks.toArray();
      const projects = {};
      tasks.forEach(t => { projects[t.project] = projects[t.project]||[]; projects[t.project].push(t); });
      for(const [proj, tlist] of Object.entries(projects)) {
        projDiv.innerHTML += `<h3>${proj}</h3>`;
        tlist.forEach(t => {
          let subHTML = t.subtasks?.map(s=>`<p class="${s.status==='Completed'?'completed':''}">${s.date_code}: ${s.title} [${s.status}]</p>`).join('')||'_No subtasks_';
          projDiv.innerHTML += `<div class="task"><strong>${t.task}</strong>${subHTML}</div>`;
        });
      }
    }
  }

  // ================= CRUD functions =================
  window.deleteTask = async (id) => {
    await db.tasks.delete(id);
    renderPage(pageSelect.value);
  };

  window.completeSub = async (taskId, subIdx) => {
    const task = await db.tasks.get(taskId);
    task.subtasks[subIdx].status = "Completed";
    await db.tasks.put(task);
    renderPage(pageSelect.value);
  };

  // ================= Service Worker =================
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }

  // ================= Initial Render =================
  renderPage("dashboard");
</script>
</body>
</html>
