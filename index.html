<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Protocol Tracker PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB">
  <script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 1rem; padding-bottom: 80px; }
    input, textarea, select, button { width: 100%; margin: 5px 0; padding: 8px; font-size: 1rem; }
    h2 { margin-top: 1rem; }
    .task { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    .subtask { margin-left: 15px; }
    .completed { color: gray; text-decoration: line-through; }
    .overdue { color: red; }

    /* Bottom navigation */
    #bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #ccc;
      padding: 10px 0;
      z-index: 999;
    }
    #bottom-nav button {
      font-size: 24px;
      border: none;
      background: none;
      flex: 1;
      text-align: center;
      cursor: pointer;
    }
    #bottom-nav button.active {
      background-color: #0d6efd;
      color: white;
      border-radius: 6px;
    }
    .page { display: none; }
  </style>
</head>
<body>

<h1>üìä Protocol Tracker</h1>

<!-- Pages -->
<div id="dashboardPage" class="page"></div>
<div id="createPage" class="page"></div>
<div id="tasksPage" class="page"></div>
<div id="dailyPage" class="page"></div>
<div id="projectsPage" class="page"></div>



<!-- Bottom Navigation -->
<div id="bottom-nav">
  <button id="nav-dashboard" onclick="navigate('dashboard')">üè†</button>
  <button id="nav-daily" onclick="navigate('daily')">üìÖ</button>
  <button id="nav-create" onclick="navigate('create')">‚ûï</button>
  <button id="nav-tasks" onclick="navigate('tasks')">üìã</button>
  <button id="nav-projects" onclick="navigate('projects')">üìÇ</button>
</div>

<script>
  // ================= Dexie DB Setup =================
  const db = new Dexie("protocolTrackerDB");
  db.version(2).stores({
    tasks: "++id, project, task, description, status, created_at, order"
  });

  const pages = {
    dashboard: document.getElementById("dashboardPage"),
    create: document.getElementById("createPage"),
    tasks: document.getElementById("tasksPage"),
    daily: document.getElementById("dailyPage"),
    projects: document.getElementById("projectsPage")
  };

  await normalizeTaskOrder();
  navigate("daily");

  // ================= Drag & Drop Helpers =================
  let draggedTask = null;

  function handleDragStart(e) {
    draggedTask = this;
    this.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  }

  function handleDragOver(e) {
    e.preventDefault(); // REQUIRED so drop works
    return false;
  }

  function handleDrop(e) {
    e.stopPropagation();

    if (draggedTask !== this) {
      const parent = this.parentNode;
      const draggedIndex = [...parent.children].indexOf(draggedTask);
      const targetIndex  = [...parent.children].indexOf(this);

      if (draggedIndex < targetIndex) {
        parent.insertBefore(draggedTask, this.nextSibling);
      } else {
        parent.insertBefore(draggedTask, this);
      }

      saveTaskOrder(parent);
    }
  }

  // ================= SAVE ORDER (Step B) =================
  async function saveTaskOrder(container) {
    const taskDivs = [...container.children];

    for (let i = 0; i < taskDivs.length; i++) {
      const id = Number(taskDivs[i].dataset.taskId);
      const task = await db.tasks.get(id);
      if (!task) continue;

      task.order = i;
      await db.tasks.put(task);
    }
  }


  // ================= Navigation =================
  function navigate(page) {
    // hide all pages
    Object.values(pages).forEach(p => p.style.display = 'none');
    // show selected page
    pages[page].style.display = 'block';
    // highlight active button
    document.querySelectorAll('#bottom-nav button').forEach(b => b.classList.remove('active'));
    document.getElementById("nav-" + page).classList.add('active');
    // render page content
    renderPage(page);
  }

  // ================= Helper: Extract subtasks =================
  function extractSubtasks(description) {
    const pattern = /(\d{4}):\s*(.+)/g;
    let match, subtasks = [];
    while ((match = pattern.exec(description)) !== null) {
      let code = match[1];
      let text = match[2];
      subtasks.push({date_code: code, title: text, status: "Not Started"});
    }
    return subtasks;
  }

  // ================= Pages =================
  async function renderPage(page) {
    if (page === "dashboard") {
      const dash = pages.dashboard;
      dash.innerHTML = "<h2>üìä Dashboard</h2>";
      const tasks = await db.tasks.toArray();
      const totalProjects = new Set(tasks.map(t => t.project)).size;
      const totalTasks = tasks.length;
      let todayNum = parseInt(new Date().toISOString().slice(5,7)+new Date().toISOString().slice(8,10));
      let overdue = 0, today = 0;
      tasks.forEach(t => {
        t.subtasks?.forEach(s => {
          let num = parseInt(s.date_code);
          if(s.status !== "Completed") {
            if(num < todayNum) overdue++;
            else if(num === todayNum) today++;
          }
        });
      });
      dash.innerHTML += `<p>üß™ Total Projects: ${totalProjects}</p>`;
      dash.innerHTML += `<p>üìÇ Total Tasks: ${totalTasks}</p>`;
      dash.innerHTML += `<p>‚ö†Ô∏è Overdue Subtasks: ${overdue}</p>`;
      dash.innerHTML += `<p>üìÖ Today's Subtasks: ${today}</p>`;
    }

    if(page === "create") {
      const create = pages.create;
      create.innerHTML = `<h2>‚ûï Create Task</h2>
      <input id="projInput" placeholder="Project Name">
      <input id="taskInput" placeholder="Task Name">
      <textarea id="descInput" rows="10" cols="40" placeholder="Task Description (use 0101: Subtask format)"></textarea>
      <select id="statusInput">
        <option>Not Started</option>
        <option>In Progress</option>
        <option>Completed</option>
      </select>
      <button id="saveBtn">Save Task</button>
      <p id="msg"></p>`;
      document.getElementById("saveBtn").onclick = async () => {
        const project = document.getElementById("projInput").value.trim();
        const task = document.getElementById("taskInput").value.trim();
        const description = document.getElementById("descInput").value.trim();
        const status = document.getElementById("statusInput").value;
        if(!project || !task) { document.getElementById("msg").innerText="Fill project & task!"; return; }
        const subtasks = extractSubtasks(description);

        const count = await db.tasks.count();
        await db.tasks.add({ project, task, description, status, subtasks, order: count, created_at: new Date().toLocaleString("en-US", { timeZone: "America/Chicago" }) });
        document.getElementById("msg").innerText = "‚úÖ Task Saved!";
        document.getElementById("projInput").value="";
        document.getElementById("taskInput").value="";
        document.getElementById("descInput").value="";
      };
    }

    if(page === "tasks") {
      const tasksDiv = pages.tasks;
      tasksDiv.innerHTML = "<h2>üìã Current Tasks</h2>";
      const tasks = await db.tasks.reverse().toArray();
      tasksDiv.innerHTML += tasks.map((t, idx) => {
        let subHTML = t.subtasks?.map((s, si) => `<div class="subtask ${s.status==='Completed'?'completed':''}">${s.date_code}: ${s.title} [${s.status}] <button onclick="completeSub(${t.id},${si})">‚úÖ</button></div>`).join('') || '';
        return `<div class="task"><h3>${t.task} (${t.project})</h3>
                <p>Status: ${t.status}</p>
                <p>${t.description}</p>
                ${subHTML}
                <button onclick="deleteTask(${t.id})">üóëÔ∏è Delete Task</button></div>`;
      }).join('');
    }

    if (page === "daily") {
      const dailyDiv = pages.daily;
      dailyDiv.innerHTML = "<h2>üìÖ Daily Tasks</h2>";

      const tasks = await db.tasks.orderBy("order").toArray();
      // --- Use Chicago local date (America/Chicago timezone) ---
      const chicagoNow = new Date().toLocaleString("en-US", { timeZone: "America/Chicago" });
      const chicagoDate = new Date(chicagoNow);
      const month = String(chicagoDate.getMonth() + 1).padStart(2, "0");
      const day = String(chicagoDate.getDate()).padStart(2, "0");
      const todayNum = parseInt(month + day);


      let anyVisible = false;

      tasks.forEach((t) => {
        const visibleSubs =
          t.subtasks?.filter((s) => {
            const subNum = parseInt(s.date_code);
            const status = s.status;
            return subNum <= todayNum && !(status === "Completed" && subNum < todayNum);
          }) || [];

        if (visibleSubs.length > 0) {
          anyVisible = true;

          const taskContainer = document.createElement("div");
          taskContainer.className = "task";
          taskContainer.draggable = true;
          taskContainer.dataset.taskId = t.id;   // Dexie primary key
          taskContainer.addEventListener("dragstart", handleDragStart);
          taskContainer.addEventListener("dragover", handleDragOver);
          taskContainer.addEventListener("drop", handleDrop);
          taskContainer.addEventListener("dragend", () => {
            taskContainer.classList.remove("dragging");
          });


          // === Header: title + edit button ===
          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.justifyContent = "space-between";
          header.style.alignItems = "center";

          const title = document.createElement("h3");
          title.innerText = `üîπ ${t.task} (${t.project})`;
          header.appendChild(title);

          const editBtn = document.createElement("button");
          editBtn.innerHTML = "‚úèÔ∏è Edit";
          editBtn.style.fontSize = "1rem";
          editBtn.style.width = "70px";
          editBtn.style.height = "32px";
          editBtn.style.padding = "0";
          editBtn.style.borderRadius = "8px";
          editBtn.style.cursor = "pointer";
          editBtn.style.background = "#eee";
          editBtn.style.border = "1px solid #ccc";
          editBtn.style.transition = "0.2s";

          editBtn.onmouseover = () => (editBtn.style.background = "#ddd");
          editBtn.onmouseout = () => (editBtn.style.background = "#eee");

          header.appendChild(editBtn);
          taskContainer.appendChild(header);


          // Editable description (without subtasks)
          let editing = false;
          let descElem = null; //

          editBtn.onclick = () => {
            if(!editing) {
              editing = true;
              const textarea = document.createElement("textarea");
              textarea.value = t.description; // only description text
              textarea.style.width = "100%";
              textarea.style.marginTop = "5px";

              const saveBtn = document.createElement("button");
              saveBtn.innerText = "üíæ Save";
              saveBtn.style.marginTop = "5px";

              saveBtn.onclick = async () => {
                t.description = textarea.value;       // update parent description
                t.subtasks = extractSubtasks(textarea.value); // regenerate subtasks if you want
                await db.tasks.put(t);
                navigate("daily"); // rerender daily page
              };

              taskContainer.appendChild(textarea);
              taskContainer.appendChild(saveBtn);
            }
          };


          // === Render visible subtasks ===
          visibleSubs.forEach((s) => {
            const subNum = parseInt(s.date_code);
            const status = s.status;

            const subRow = document.createElement("div");
            subRow.style.display = "flex";
            subRow.style.justifyContent = "space-between";
            subRow.style.alignItems = "center";
            subRow.style.margin = "4px 0";

            // Subtask text
            const subElem = document.createElement("p");
            subElem.innerText = `${subNum}: ${s.title}`;
            subElem.style.margin = "0";
            subElem.style.flex = "1";
            if (status === "Completed") subElem.classList.add("completed");
            else if (subNum < todayNum) subElem.classList.add("overdue");

            subRow.appendChild(subElem);

            // Complete button (if not done)
            if (status !== "Completed") {
              const btn = document.createElement("button");
              btn.innerHTML = "‚úÖ";
              btn.style.fontSize = "1rem";
              btn.style.width = "32px";
              btn.style.height = "32px";
              btn.style.padding = "0";
              btn.style.borderRadius = "8px";
              btn.style.cursor = "pointer";
              btn.style.background = "#eee";
              btn.style.border = "1px solid #ccc";
              btn.style.transition = "0.2s";
              btn.style.marginLeft = "8px";

              btn.onmouseover = () => (btn.style.background = "#ddd");
              btn.onmouseout  = () => (btn.style.background = "#eee");

              btn.onclick = async () => {
                s.status = "Completed";
                await db.tasks.put(t);
                navigate("daily");
              };

              subRow.appendChild(btn);
            
            }

            taskContainer.appendChild(subRow);
          });

          dailyDiv.appendChild(taskContainer);
        }
      });

      if (!anyVisible)
        dailyDiv.innerHTML += "<p>No subtasks due today or earlier.</p>";
    }


    if(page==="projects") {
      const projDiv = pages.projects;
      projDiv.innerHTML="<h2>üìÇ Project Overview</h2>";
      const tasks = await db.tasks.toArray();
      const projects = {};
      tasks.forEach(t => { projects[t.project] = projects[t.project]||[]; projects[t.project].push(t); });
      for(const [proj, tlist] of Object.entries(projects)) {
        projDiv.innerHTML += `<h3>${proj}</h3>`;
        tlist.forEach(t => {
          let subHTML = t.subtasks?.map(s=>`<p class="${s.status==='Completed'?'completed':''}">${s.date_code}: ${s.title} [${s.status}]</p>`).join('')||'_No subtasks_';
          projDiv.innerHTML += `<div class="task"><strong>${t.task}</strong>${subHTML}</div>`;
        });
      }
    }
  }

  // ================= CRUD functions =================
  window.deleteTask = async (id) => { await db.tasks.delete(id); renderPage(currentPage); };
  window.completeSub = async (taskId, subIdx) => {
    const task = await db.tasks.get(taskId);
    task.subtasks[subIdx].status = "Completed";
    await db.tasks.put(task);
    renderPage(currentPage);
  };

  // ================= Service Worker =================
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');

  // ================= Initial Render =================
  let currentPage = "dashboard";
  navigate(currentPage);
</script>
</body>
</html>



